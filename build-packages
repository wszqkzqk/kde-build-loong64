#!/bin/bash

. common

rm -f broken-packages
basedir=${PWD}

# Pass i686 as argument if you want to build i686 packages on a x86_64 system
arch=$1
[[ -z ${arch} ]] && arch=$(uname -m)

for i in ${depPkgName}; do
        _pushd build/${i}/${svnbranch}
        if $clean_chroot ; then
                sudo ${repo}-${arch}-build || ( echo ${i} >> ${basedir}/broken-packages )
        elif [ "${i}" = "kdebase-runtime" ] ; then
                sudo ${repo}-${arch}-build || exit 1
        else
                setarch ${arch} sudo makechrootpkg -r /var/lib/archbuild/${repo}-${arch} -n || exit 1
        fi
        _popd
done

for i in ${optPkgName}; do
        _pushd build/${i}/${svnbranch}
        if $clean_chroot ; then
                sudo ${repo}-${arch}-build || ( echo ${i} >> ${basedir}/broken-packages )
        else
                setarch ${arch} sudo makechrootpkg -r /var/lib/archbuild/${repo}-${arch} -n || ( echo ${i} >> ${basedir}/broken-packages )
        fi
        _popd
done

if [ -s broken-packages ]; then
	echo "Broken packages:"
	cat broken-packages
else
	echo "All packages built successfully!"
fi
